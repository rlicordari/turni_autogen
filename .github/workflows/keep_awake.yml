name: Keep Streamlit Awake

on:
  schedule:
    - cron: "*/30 * * * *"   # ogni 30 minuti
  workflow_dispatch:

concurrency:
  group: keep-streamlit-awake
  cancel-in-progress: false

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Streamlit app (burst retry on failure)
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          set -u  # niente variabili non definite

          if [ -z "${STREAMLIT_APP_URL:-}" ]; then
            echo "Missing secret STREAMLIT_APP_URL (Repo → Settings → Secrets and variables → Actions)."
            exit 1
          fi

          # Modalità recupero: riprova ogni 30s fino a 25 min
          RETRY_EVERY_SECONDS=30
          MAX_RECOVERY_SECONDS=$((25*60))
          DEADLINE=$(( $(date +%s) + MAX_RECOVERY_SECONDS ))

          attempt=0
          while true; do
            attempt=$((attempt+1))

            # Non far terminare lo script se curl fallisce
            set +e
            http_code=$(curl -L -sS -o /dev/null -w "%{http_code}" \
              --connect-timeout 15 --max-time 180 "$STREAMLIT_APP_URL")
            rc=$?
            set -e

            ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "[$ts] Attempt $attempt: curl_rc=$rc http=$http_code url=$STREAMLIT_APP_URL"

            # OK se 2xx o 3xx
            if [ $rc -eq 0 ] && [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
              echo "Ping OK"
              exit 0
            fi

            now=$(date +%s)
            if [ $now -ge $DEADLINE ]; then
              echo "Ping still failing after recovery window (${MAX_RECOVERY_SECONDS}s). Failing job to alert."
              exit 1
            fi

            echo "Ping failed. Retrying in ${RETRY_EVERY_SECONDS}s..."
            sleep "$RETRY_EVERY_SECONDS"
          done
