name: Keep Streamlit Awake

on:
  schedule:
    - cron: "*/30 * * * *"   # ogni 30 minuti
  workflow_dispatch:

concurrency:
  group: keep-streamlit-awake
  cancel-in-progress: false

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Streamlit app (fast recovery mode; prefer health endpoint)
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          set -u

          if [ -z "${STREAMLIT_APP_URL:-}" ]; then
            echo "Missing secret STREAMLIT_APP_URL (Repo → Settings → Secrets and variables → Actions)."
            exit 1
          fi

          # Preferisco pingare un endpoint stabile (evita redirect loop sulla homepage)
          BASE="${STREAMLIT_APP_URL%/}"
          HEALTH_URL="${BASE}/_stcore/health"
          ROOT_URL="${BASE}/"

          # Modalità recupero: se fallisce, riprova ogni 30s fino a 25 min
          RETRY_EVERY_SECONDS=30
          MAX_RECOVERY_SECONDS=$((25*60))
          DEADLINE=$(( $(date +%s) + MAX_RECOVERY_SECONDS ))

          attempt=0
          while true; do
            attempt=$((attempt+1))

            set +e
            # 1) prova health (NO -L per non inseguire redirect infiniti)
            health_code=$(curl -sS -o /dev/null -w "%{http_code}"               --connect-timeout 15 --max-time 60 "$HEALTH_URL")
            health_rc=$?

            # 2) fallback: prova root (con pochi redirect massimi)
            root_code=""
            root_rc=0
            if [ $health_rc -ne 0 ] || [ "$health_code" -lt 200 ] || [ "$health_code" -ge 400 ]; then
              root_code=$(curl -L -sS -o /dev/null -w "%{http_code}"                 --max-redirs 10 --connect-timeout 15 --max-time 180 "$ROOT_URL")
              root_rc=$?
            fi
            set -e

            ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "[$ts] Attempt $attempt:"
            echo "  health: curl_rc=$health_rc http=$health_code url=$HEALTH_URL"
            if [ -n "$root_code" ]; then
              echo "  root:   curl_rc=$root_rc http=$root_code url=$ROOT_URL"
            fi

            # Successo se health è 2xx/3xx (tipicamente 200/204/304) oppure root è 2xx/3xx
            if [ $health_rc -eq 0 ] && [ "$health_code" -ge 200 ] && [ "$health_code" -lt 400 ]; then
              echo "Ping OK (health)"
              exit 0
            fi
            if [ -n "$root_code" ] && [ $root_rc -eq 0 ] && [ "$root_code" -ge 200 ] && [ "$root_code" -lt 400 ]; then
              echo "Ping OK (root)"
              exit 0
            fi

            # Se curl fallisce con 'Maximum redirects followed' (47), è spesso un vero redirect loop.
            if [ -n "$root_code" ] && [ $root_rc -eq 47 ]; then
              echo "Detected redirect loop on root (curl rc=47)."
            fi

            now=$(date +%s)
            if [ $now -ge $DEADLINE ]; then
              echo "Ping still failing after recovery window (${MAX_RECOVERY_SECONDS}s). Failing job to alert."
              exit 1
            fi

            echo "Ping failed. Retrying in ${RETRY_EVERY_SECONDS}s..."
            sleep "$RETRY_EVERY_SECONDS"
          done
